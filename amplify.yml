version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
        # Debug environment variables
        - echo "Checking available environment variables..."
        - echo "OPENAI_API_KEY exists? $(if [ -n \"$OPENAI_API_KEY\" ]; then echo YES; else echo NO; fi)"
        - echo "NEXT_PUBLIC_SUPABASE_URL exists? $(if [ -n \"$NEXT_PUBLIC_SUPABASE_URL\" ]; then echo YES; else echo NO; fi)"
        - echo "NEXT_PUBLIC_SUPABASE_ANON_KEY exists? $(if [ -n \"$NEXT_PUBLIC_SUPABASE_ANON_KEY\" ]; then echo YES; else echo NO; fi)"
        # Create .env files for both build and runtime
        - touch .env.local
        - '[ ! -z "$OPENAI_API_KEY" ] && echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env.local'
        - '[ ! -z "$NEXT_PUBLIC_SUPABASE_URL" ] && echo "NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL" >> .env.local'
        - '[ ! -z "$NEXT_PUBLIC_SUPABASE_ANON_KEY" ] && echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY" >> .env.local'
        - cp .env.local .env.production
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - .next/cache/**/*
      - .npm/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: 'Cache-Control'
          value: 'public, max-age=31536000, immutable'
  environment:
    variables:
      # These variables are defined in the Amplify Console and not here
      # They are listed here as a reminder of what needs to be added to the environment
      # OPENAI_API_KEY:
      # NEXT_PUBLIC_SUPABASE_URL:
      # NEXT_PUBLIC_SUPABASE_ANON_KEY: 